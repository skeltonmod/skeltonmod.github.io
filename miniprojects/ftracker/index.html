<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>FTracker</title>
    <link rel="stylesheet" href="style.css" />
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
      defer
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
      defer
    ></script>
    <script src="script.js"></script>
  </head>
  <body>
    <div class="frame" x-data="financeReport()" x-init="init()" x-cloak>
      
      <div class="title">
        <div>Elijah's Dogshit expense tracker (for morons)</div>
        <div style="font-size: 11px; opacity: 0.9">v2006 · local-only</div>
      </div>

      <div class="toolbar">
        <button class="ym-button" @click="addSample()">+ Sample</button>
        <button class="ym-button" @click="save()">Save</button>
        <button class="ym-button" @click="load()">Load</button>
        <button class="ym-button" @click="resetStorage()">Reset</button>
        <button class="ym-button" @click="importCSV()">Import CSV</button>
        <button class="ym-button" @click="downloadCSV()">Export CSV</button>
        <div style="flex: 1"></div>
        <div class="muted small">
          Auto-save: <span x-text="autoSaveEnabled ? 'ON' : 'OFF'"></span>
        </div>
        <button
          class="ym-button"
          @click="autoSaveEnabled = !autoSaveEnabled"
          x-text="autoSaveEnabled ? 'Disable' : 'Enable'"
        ></button>
      </div>

      <div class="panel">
        <div class="left">
          <!-- Section selection -->
          <div style="margin-bottom: 12px; padding: 8px; background: #f9f9f9; border: 1px solid #aaa;">
            <div style="display: flex; gap: 6px; align-items: center; margin-bottom: 6px;">
              <label class="small" style="font-weight: bold; flex: 1;">
                Current Section:
                <select
                  class="input-old"
                  x-model="currentSection"
                  @change="drawChart()"
                  style="width: 200px; margin-left: 6px;"
                >
                  <template x-for="section in sections" :key="section.id">
                    <option :value="section.id" x-text="section.name"></option>
                  </template>
                </select>
              </label>
              <button class="ym-button mini" @click="$dispatch('open-section-modal')">+ Add Section</button>
            </div>
            <div x-show="currentSection !== 'default'" style="display: flex; gap: 6px; align-items: center;">
              <input
                class="input-old"
                type="text"
                :value="sections.find(s => s.id === currentSection)?.name || ''"
                @input="tempSectionName = $event.target.value"
                placeholder="Section name"
                style="flex: 1;"
              />
              <button 
                class="ym-button mini" 
                @click="updateSectionName()"
              >Save Name</button>
              <button 
                class="ym-button mini" 
                @click="deleteSection(currentSection)"
              >Delete Section</button>
            </div>
          </div>

          <!-- Date Filtering -->
          <div style="margin-bottom: 12px; padding: 8px; background: #f0f0f0; border: 1px solid #aaa;">
            <div style="margin-bottom: 6px;">
              <label class="small" style="font-weight: bold;">
                Date Filter:
                <select
                  class="input-old small"
                  x-model="filterType"
                  @change="drawChart()"
                  style="width: 120px; margin-left: 6px;"
                >
                  <option value="none">No Filter</option>
                  <option value="year">By Year</option>
                  <option value="month">By Month</option>
                  <option value="monthrange">Month Range</option>
                  <option value="daterange">Date Range</option>
                </select>
              </label>
            </div>

            <!-- Year Filter -->
            <div x-show="filterType === 'year' || filterType === 'month' || filterType === 'monthrange'" style="margin-bottom: 6px;">
              <label class="small">
                Year:
                <select
                  class="input-old small"
                  x-model="filterYear"
                  @change="drawChart()"
                  style="width: 80px; margin-left: 6px;"
                >
                  <option value="all">All</option>
                  <template x-for="y in years" :key="y">
                    <option :value="y" x-text="y"></option>
                  </template>
                </select>
              </label>
            </div>

            <!-- Month Filter -->
            <div x-show="filterType === 'month'" style="margin-bottom: 6px;">
              <label class="small">
                Month:
                <select
                  class="input-old small"
                  x-model="filterMonth"
                  @change="drawChart()"
                  style="width: 100px; margin-left: 6px;"
                >
                  <template x-for="(m,i) in months" :key="i">
                    <option :value="i+1" x-text="m"></option>
                  </template>
                </select>
              </label>
            </div>

            <!-- Month Range Filter -->
            <div x-show="filterType === 'monthrange'">
              <div style="margin-bottom: 4px;">
                <label class="small">
                  From Month:
                  <select
                    class="input-old small"
                    x-model="filterStartMonth"
                    @change="drawChart()"
                    style="width: 100px; margin-left: 6px;"
                  >
                    <template x-for="(m,i) in months" :key="i">
                      <option :value="i+1" x-text="m"></option>
                    </template>
                  </select>
                </label>
              </div>
              <div style="margin-bottom: 6px;">
                <label class="small">
                  To Month:
                  <select
                    class="input-old small"
                    x-model="filterEndMonth"
                    @change="drawChart()"
                    style="width: 100px; margin-left: 6px;"
                  >
                    <template x-for="(m,i) in months" :key="i">
                      <option :value="i+1" x-text="m"></option>
                    </template>
                  </select>
                </label>
              </div>
            </div>

            <!-- Date Range Filter -->
            <div x-show="filterType === 'daterange'" style="display: flex; gap: 6px; align-items: center;">
              <label class="small">
                From:
                <input
                  class="input-old small"
                  type="date"
                  x-model="filterStartDate"
                  @change="drawChart()"
                  style="width: 130px; margin-left: 6px;"
                />
              </label>
              <label class="small">
                To:
                <input
                  class="input-old small"
                  type="date"
                  x-model="filterEndDate"
                  @change="drawChart()"
                  style="width: 130px; margin-left: 6px;"
                />
              </label>
            </div>
          </div>

          <!-- Income table -->
          <div style="margin-bottom: 8px">
            <strong>Income</strong>
            <table class="grid">
              <thead>
                <tr>
                  <th style="width: 110px">Date</th>
                  <th style="width: 140px">Source</th>
                  <th>Description</th>
                  <th style="width: 100px">Amount (PHP)</th>
                  <th style="width: 80px">#</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(it, idx) in filteredIncome" :key="it.id">
                  <tr>
                    <td>
                      <input
                        class="input-old"
                        type="date"
                        x-model="it.date"
                        @change="persistIfAuto()"
                      />
                    </td>
                    <td>
                      <input
                        class="input-old"
                        x-model="it.name"
                        @input="persistIfAuto()"
                      />
                    </td>
                    <td>
                      <input
                        class="input-old"
                        x-model="it.desc"
                        @input="persistIfAuto()"
                        placeholder="Description"
                      />
                    </td>
                    <td>
                      <input
                        class="input-old"
                        type="number"
                        step="0.01"
                        x-model.number="it.amount"
                        @input="persistIfAuto()"
                        style="text-align: right"
                      />
                    </td>
                    <td>
                      <button class="bevel mini" @click="duplicateIncome(it.id)" title="Duplicate">+</button>
                      <button class="bevel mini" @click="removeIncomeById(it.id)">x</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div style="text-align: right; margin-top: 6px">
              <button class="ym-button mini" @click="addIncome()">
                + Add Income
              </button>
            </div>
          </div>

          <!-- Expenses table -->
          <div>
            <strong>Expenses</strong>
            <table class="grid">
              <thead>
                <tr>
                  <th style="width: 110px">Date</th>
                  <th style="width: 110px">Category</th>
                  <th>Description</th>
                  <th style="width: 100px">Amount (PHP)</th>
                  <th style="width: 100px">#</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(it, idx) in filteredExpenses" :key="it.id">
                  <tr>
                    <td>
                      <input
                        class="input-old"
                        type="date"
                        x-model="it.date"
                        @change="persistIfAuto()"
                      />
                    </td>
                    <td>
                      <input
                        class="input-old"
                        x-model="it.category"
                        @input="persistIfAuto()"
                      />
                    </td>
                    <td>
                      <input
                        class="input-old"
                        x-model="it.desc"
                        @input="persistIfAuto()"
                        placeholder="Description"
                      />
                    </td>
                    <td>
                      <input
                        class="input-old"
                        type="number"
                        step="0.01"
                        x-model.number="it.amount"
                        @input="persistIfAuto()"
                        style="text-align: right"
                      />
                    </td>
                    <td>
                      <button class="bevel mini" @click="duplicateExpense(it.id)" title="Duplicate">+</button>
                      <button class="bevel mini" @click="removeExpenseById(it.id)">
                        x
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div style="text-align: right; margin-top: 6px">
              <button class="ym-button mini" @click="addExpense()">
                + Add Expense
              </button>
            </div>
          </div>
        </div>

        <div class="right">
          <div style="margin-bottom: 8px"><strong>Monthly Summary</strong></div>

          <div style="margin-bottom: 8px">
            <label class="small" style="display: block; margin-bottom: 6px;">
              Summary Filter:
              <select
                class="input-old small"
                x-model="summaryFilterType"
                @change="drawChart()"
                style="width: 120px; margin-left: 6px;"
              >
                <option value="all">All Data</option>
                <option value="year">By Year</option>
                <option value="month">By Month</option>
                <option value="monthrange">Month Range</option>
                <option value="daterange">Date Range</option>
              </select>
            </label>

            <!-- Year Filter for Summary -->
            <div x-show="summaryFilterType === 'year' || summaryFilterType === 'month' || summaryFilterType === 'monthrange'" style="margin-bottom: 6px;">
              <label class="small">
                Year:
                <select
                  class="input-old small"
                  x-model="summaryYear"
                  @change="drawChart()"
                  style="width: 80px; margin-left: 6px;"
                >
                  <option value="all">All</option>
                  <template x-for="y in years" :key="y">
                    <option :value="y" x-text="y"></option>
                  </template>
                </select>
              </label>
            </div>

            <!-- Month Filter for Summary -->
            <div x-show="summaryFilterType === 'month'" style="margin-bottom: 6px;">
              <label class="small">
                Month:
                <select
                  class="input-old small"
                  x-model="summaryMonth"
                  @change="drawChart()"
                  style="width: 100px; margin-left: 6px;"
                >
                  <template x-for="(m,i) in months" :key="i">
                    <option :value="i+1" x-text="m"></option>
                  </template>
                </select>
              </label>
            </div>

            <!-- Month Range Filter for Summary -->
            <div x-show="summaryFilterType === 'monthrange'">
              <div style="margin-bottom: 4px;">
                <label class="small">
                  From Month:
                  <select
                    class="input-old small"
                    x-model="summaryStartMonth"
                    @change="drawChart()"
                    style="width: 100px; margin-left: 6px;"
                  >
                    <template x-for="(m,i) in months" :key="i">
                      <option :value="i+1" x-text="m"></option>
                    </template>
                  </select>
                </label>
              </div>
              <div style="margin-bottom: 6px;">
                <label class="small">
                  To Month:
                  <select
                    class="input-old small"
                    x-model="summaryEndMonth"
                    @change="drawChart()"
                    style="width: 100px; margin-left: 6px;"
                  >
                    <template x-for="(m,i) in months" :key="i">
                      <option :value="i+1" x-text="m"></option>
                    </template>
                  </select>
                </label>
              </div>
            </div>

            <!-- Date Range Filter for Summary -->
            <div x-show="summaryFilterType === 'daterange'">
              <div style="margin-bottom: 4px;">
                <label class="small">
                  From:
                  <input
                    class="input-old small"
                    type="date"
                    x-model="summaryStartDate"
                    @change="drawChart()"
                    style="width: 130px; margin-left: 6px;"
                  />
                </label>
              </div>
              <div style="margin-bottom: 6px;">
                <label class="small">
                  To:
                  <input
                    class="input-old small"
                    type="date"
                    x-model="summaryEndDate"
                    @change="drawChart()"
                    style="width: 130px; margin-left: 6px;"
                  />
                </label>
              </div>
            </div>
          </div>

          <table class="grid small" style="width: 100%; margin-bottom: 8px">
            <tr>
              <th>Income Total</th>
              <td style="text-align: right" x-text="format(summaryIncome)">
                0.00
              </td>
            </tr>
            <tr>
              <th>Expenses Total</th>
              <td style="text-align: right" x-text="format(summaryExpenses)">
                0.00
              </td>
            </tr>
            <tr>
              <th>Net Income</th>
              <td style="text-align: right">
                <strong x-text="format(summaryNet)">0.00</strong>
              </td>
            </tr>
          </table>

          <div class="canvas-frame">
            <canvas
              id="barChart"
              width="280"
              height="160"
              style="
                display: block;
                margin: 0 auto;
                background: #efefef;
                border: 1px solid #aaa;
              "
            ></canvas>
            <div
              class="muted small"
              style="text-align: center; margin-top: 6px"
            >
              Monthly chart
            </div>
          </div>

          <div style="margin-top: 10px">
            <button
              class="ym-button"
              style="width: 100%; margin-bottom: 4px"
              @click="printReport()"
            >
              Print
            </button>
          </div>

          <div style="margin-top: 10px">
            <strong>Legend</strong>
            <div class="small muted">
              Use filters to view specific months. Save to browser storage.
              Export for backup.
            </div>
          </div>
        </div>
      </div>

      <div class="statusbar">
        <div id="status" x-text="statusText">Ready</div>
        <div
          class="muted"
          x-text="income.length + ' income · ' + expenses.length + ' expenses'"
        >
          0 income · 0 expenses
        </div>
      </div>
    </div>

    <!-- Section Creation Modal -->
    <div x-data="{ 
      showModal: false, 
      sectionName: '',
      createSection() {
        if (!this.sectionName.trim()) {
          alert('Please enter a section name');
          return;
        }
        this.$dispatch('create-section', this.sectionName.trim());
        this.sectionName = '';
        this.showModal = false;
      }
    }" @open-section-modal.window="showModal = true; $nextTick(() => $refs.modalInput.focus())">
      <div 
        class="modal-wrapper"
        :class="{ 'active': showModal }"
        x-cloak
      >
        <div class="backdrop" @click="showModal = false; sectionName = ''"></div>
        <div 
          class="modal-panel"
          :class="{ 'active': showModal }"
          @click.stop
        >
          <div class="modal-header">
            Create New Section
          </div>
          
          <div class="modal-body">
            <label class="small" style="display: block; margin-bottom: 3px;">
              Section Name:
            </label>
            <input
              class="input-old"
              type="text"
              x-model="sectionName"
              @keyup.enter="createSection()"
              placeholder="Enter section name"
              style="width: 100%; padding: 4px;"
              x-ref="modalInput"
            />
          </div>
          
          <div class="modal-footer">
            <button 
              class="ym-button mini" 
              @click="showModal = false; sectionName = ''"
              style="min-width: 70px;"
            >
              Cancel
            </button>
            <button 
              class="ym-button mini" 
              @click="createSection()"
              style="min-width: 70px;"
            >
              Create
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
